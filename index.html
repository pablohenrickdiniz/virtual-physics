<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Simulação</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" href="css/index.css"/>
    <script type="text/javascript" src="js/utils/jquery.min.js"></script>
    <script type="text/javascript" src="js/utils/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/utils/jquery.mousewheel.min.js"></script>
    <script type="text/javascript" src="js/utils/KeyReader.js"></script>
    <script type="text/javascript" src="js/utils/MouseReader.js"></script>
    <script type="text/javascript" src="js/draw/Color.js"></script>
    <script type="text/javascript" src="js/draw/RadialGradient.js"></script>
    <script type="text/javascript" src="js/draw/LinearGradient.js"></script>
    <script type="text/javascript" src="js/draw/Canvas.js"></script>
    <script type="text/javascript" src="js/draw/Border.js"></script>
    <script type="text/javascript" src="js/shapes/Shape.js"></script>
    <script type="text/javascript" src="js/shapes/Polygon.js"></script>
    <script type="text/javascript" src="js/shapes/Regular.js"></script>
    <script type="text/javascript" src="js/shapes/Trapezius.js"></script>
    <script type="text/javascript" src="js/shapes/Rect.js"></script>
    <script type="text/javascript" src="js/physics/Material.js"></script>
    <script type="text/javascript" src="js/physics/MV.js"></script>
    <script type="text/javascript" src="js/physics/Body.js"></script>
    <script type="text/javascript" src="js/physics/World.js"></script>
    <script type="text/javascript" src="js/physics/friction_physics.js"></script>
    <script type="text/javascript" src="js/main/Game.js"></script>
    <script type="text/javascript" src="js/main/main.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {

            $('body').on('contextmenu', '#game', function (e) {
                return false;
            });
            var reader = new MouseReader("#game");
            var game = new Game();
            var drawing = new Canvas('drawing');
            game.start();
            reader.startRead();
            var active = false;
            var cp = [0, 0];

            KeyReader.onkeydown(KeyReader.KEY_ENTER, function () {
                if(menu.selected = 'poligono'){
                    menu.shape.updateCenter();
                    menu.shape.updateRelative();
                    var body = new Body(menu.shape,Material.Gold,$("#tipo").val()=='true');
                    game.world.addBody(body);
                    menu.shape = null;
                    menu.drawing = false;
                    menu.drawPoints=[];
                    drawing.clearScreen();
                }
            });

            $("#game").mousedown(function (event) {
                if (event.which == 3) {
                    var center = game.canvas.center;
                    active = true;
                    $("#game").css('cursor', 'move');
                    cp = [reader.x + center[0], reader.y + center[1]];
                }
            });

            $("#game").mouseup(function (event) {
                if (event.which == 3) {
                    $("#game").css('cursor', 'default');
                    active = false;
                }
            });
            $("#game").on('mousewheel', function (event) {
                if (!active) {
                    if (event.deltaY > 0 && game.canvas.scale < 20) {
                        game.canvas.scale += 0.1;
                        drawing.scale += 0.1;

                    }
                    else if (game.canvas.scale > 0.1) {
                        game.canvas.scale -= 0.1;
                        drawing.scale -= 0.1;
                    }
                }
            });

            $("#game").mousemove(function (event) {
                if (active) {
                    var x = cp[0] - reader.x;
                    var y = cp[1] - reader.y;
                    var center = [x, y];
                    game.canvas.move(center);
                    drawing.move(center);
                }
            });

            $("#action").click(function () {
                if (game.running) {
                    game.pause();
                }
                else {
                    game.continue();
                }
            });


            function Menu() {
                this.itens = ['quadrado', 'circulo', 'triangulo'];
                this.selected = null;
                this.drawing = false;
                this.drawPoints = null;
                this.body = null;
                this.shape = null;
            }

            var aux = null;
            var menu = new Menu();
            $("#quadrado").click(function () {
                menu.selected = 'quadrado';
                $("#quadrado").css('background-color', "#ddbbdd");
            });

            $("#poligono").click(function () {
                menu.selected = 'poligono';
                $("#poligono").css('background-color', "#ddbbdd");
            });

            $("#game").click(function () {
                if (!menu.drawing && menu.selected != null) {
                    var x = (reader.x + game.canvas.min[0]) / game.canvas.scale;
                    var y = (reader.y + game.canvas.min[1]) / game.canvas.scale;
                    menu.drawPoint = [x, y];
                    menu.drawing = true;
                    switch (menu.selected) {
                        case 'quadrado':

                            menu.body = new Body(new Rect([0, 0], 10, 10), Material.Iron, $("#tipo").val() == 'true');
                            menu.body.shape.color = new Color(document.getElementById("preenchimento").value);
                            menu.body.shape.border.color = new Color(document.getElementById("cor-borda").value);
                            menu.body.shape.border.thickness = document.getElementById("espessura-borda").value;
                            break;
                        case 'poligono':
                            if (menu.shape == null) {
                                menu.shape = new Polygon([0, 0], 0);
                                menu.shape.vertices.push([x, y]);
                                menu.shape.vertices.push(menu.drawPoint);
                                menu.shape.color = new Color(document.getElementById("preenchimento").value);
                                menu.shape.border.color = new Color(document.getElementById("cor-borda").value);
                                menu.shape.border.thickness = document.getElementById("espessura-borda").value;
                            }
                            break;
                    }
                }
                else if (menu.selected != null) {
                    switch (menu.selected) {
                        case 'quadrado':
                            console.log(menu.body);
                            menu.drawing = false;
                            drawing.clearScreen();
                            game.world.addBody(menu.body);
                            menu.body = null;
                            menu.drawPoint = null;
                            break;
                        case 'poligono':
                            var x = (reader.x + game.canvas.min[0]) / game.canvas.scale;
                            var y = (reader.y + game.canvas.min[1]) / game.canvas.scale;
                            menu.shape.vertices.splice(menu.shape.vertices.length - 1, 1);
                            menu.shape.vertices.push([x, y]);
                            menu.shape.vertices.push(menu.drawPoint);
                            break;
                    }
                }

            });

            $("#game").mousemove(function () {
                if (menu.drawing) {
                    var x = (reader.x + game.canvas.min[0]) / game.canvas.scale;
                    var y = (reader.y + game.canvas.min[1]) / game.canvas.scale;
                    var shape = null;
                    drawing.clearScreen();
                    switch (menu.selected) {
                        case 'quadrado':
                            var w = x - menu.drawPoint[0];
                            var h = y - menu.drawPoint[1];
                            if (w > 0 && h > 0) {
                                menu.body.shape.updateDimen(w, h);
                                menu.body.shape.center = [menu.drawPoint[0] + (w / 2), menu.drawPoint[1] + (h / 2)];
                                menu.body.setDinamic($("#tipo").val() == 'true');
                                drawing.drawShape(menu.body.shape);
                            }
                            break;
                        case 'poligono':
                            menu.drawPoint[0] = x;
                            menu.drawPoint[1] = y;
                            drawing.drawShape(menu.shape);
                    }


                }
            });


        })
        ;
    </script>
</head>
<body>
<div class="row container-fluid">
    <div class="col-md-7" style="position:relative">
        <canvas id="drawing" width="600px" height="600px" style="position:absolute;">

        </canvas>
        <canvas id="game" width="600px" height="600px" style="border:1px solid black;position:absolute;">
        </canvas>
    </div>
    <div class="col-md-5">
        <div class="row">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h4>Formas</h4>
                </div>
                <div class="panel-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="img-thumbnail text-center" id="quadrado">
                                <img src="img/square.png" width="50px"/>

                                <div class="caption">
                                    Quadrado
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="img-thumbnail text-center" id="triangulo">
                                <img src="img/triangle.png" width="50px"/>

                                <div class="caption">
                                    Triângulo
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="img-thumbnail text-center" id="poligono">
                                <img src="img/polygon.png" width="50px"/>

                                <div class="caption">
                                    Polígono
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h4>Propriedades</h4>
                </div>
                <div class="panel-body">
                    <fieldset>
                        <legend>Atributos</legend>
                        <table class="table table-striped table-responsive">
                            <tr>
                                <th style="width:130px">Tipo</th>
                                <th>Massa</th>
                                <th>Velocidade Linear</th>
                                <th>Velocidade Angular</th>
                            </tr>
                            <tr>
                                <td>
                                    <select name="tipo" id="tipo" class="form-control">
                                        <option value="true">Dinâmico</option>
                                        <option value="false">Estático</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="number" class="form-control" id="massa" name="massa" step="0.1"
                                           value="1" min="0.1"/>
                                </td>
                                <td>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <input type="number" class="form-control" id="linear-x" name="linear"
                                                   step="0.1" value="0"/>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="number" class="form-control" id="linear-y" name="linear"
                                                   step="0.1" value="0"/>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <input type="number" class="form-control" id="angular" name="angular" step="0.1"
                                           value="0"/>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                    <fieldset>
                        <legend>Aparência</legend>
                        <table class="table table-striped">
                            <tr>
                                <th>Preenchimento</th>
                                <th>Cor da Borda</th>
                                <th>Espessura da borda</th>
                            </tr>
                            <tr>
                                <td>
                                    <input class="form-control" name="preenchimento" id="preenchimento" type="color"
                                           value="#ffffff"/>
                                </td>
                                <td>
                                    <input class="form-control" name="cor-borda" id="cor-borda" type="color"/>
                                </td>
                                <td>
                                    <input class="form-control" id="espessura-borda" type="number" min="1" value="1"/>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
