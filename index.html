<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8">
<title>Simulação</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/bootstrap.min.css"/>
<link rel="stylesheet" href="css/bootstrap.icon-large.min.css"/>
<link rel="stylesheet" href="css/font-awesome.min.css"/>
<link rel="stylesheet" href="css/index.css"/>
<script type="text/javascript" src="js/utils/jquery.min.js"></script>
<script type="text/javascript" src="js/utils/bootstrap.min.js"></script>
<script type="text/javascript" src="js/utils/delaunay.js"></script>
<script type="text/javascript" src="js/utils/jquery.mousewheel.min.js"></script>
<script type="text/javascript" src="js/utils/KeyReader.js"></script>
<script type="text/javascript" src="js/utils/MouseReader.js"></script>
<script type="text/javascript" src="js/draw/Color.js"></script>
<script type="text/javascript" src="js/draw/RadialGradient.js"></script>
<script type="text/javascript" src="js/draw/LinearGradient.js"></script>
<script type="text/javascript" src="js/draw/Canvas.js"></script>
<script type="text/javascript" src="js/draw/Border.js"></script>
<script type="text/javascript" src="js/physics/MV.js"></script>
<script type="text/javascript" src="js/shapes/Shape.js"></script>
<script type="text/javascript" src="js/shapes/Polygon.js"></script>
<script type="text/javascript" src="js/shapes/Regular.js"></script>
<script type="text/javascript" src="js/shapes/Arc.js"></script>
<script type="text/javascript" src="js/shapes/Circle.js"></script>
<script type="text/javascript" src="js/shapes/Trapezius.js"></script>
<script type="text/javascript" src="js/shapes/Rect.js"></script>
<script type="text/javascript" src="js/physics/Material.js"></script>
<script type="text/javascript" src="js/physics/Body.js"></script>
<script type="text/javascript" src="js/physics/MouseBody.js"></script>
<script type="text/javascript" src="js/physics/Joint.js"></script>
<script type="text/javascript" src="js/physics/World.js"></script>
<script type="text/javascript" src="js/physics/friction_physics.js"></script>
<script type="text/javascript" src="js/main/Game.js"></script>
<script type="text/javascript" src="js/main/main.js"></script>
<script type="text/javascript">
$(document).ready(function () {
    $('body').on('contextmenu', '#game', function (e) {
        return false;
    });
    var reader = new MouseReader("#game");
    var game = new Game();
    var drawing = new Canvas('drawing');
    game.start();
    reader.startRead();
    var active = false;
    var cp = [0, 0];


    function refreshDrawing() {
        drawing.clearScreen();
        drawing.drawShape(menu.shape);
    }

    KeyReader.onkeydown(KeyReader.KEY_ENTER, function () {
        if (menu.selected == 'convex') {
            if (!menu.shape.isClockWise()) {
                var first = menu.shape.vertices.shift();
                menu.shape.vertices.reverse();
                menu.shape.vertices.unshift(first);
            }
            menu.shape.updateCenter();
            menu.shape.updateRelative();

            var body = new Body(menu.shape, Material.Gold, $("#tipo").val() == 'true');
            game.world.addBody(body);
            menu.shape = null;
            menu.drawing = false;
            menu.drawPoint = null;
            menu.auxpoint = null;
            drawing.clearScreen();
        }
    });

    KeyReader.onkeydown(KeyReader.KEY_ESC, function () {
        menu.shape = null;
        menu.drawing = false;
        menu.drawPoints = [];
        drawing.clearScreen();
    });

    KeyReader.onkeydown(KeyReader.KEY_PLUS, function () {
        if (menu.shape != null && menu.selected == 'regular') {
            menu.shape.sides++;
            menu.shape.updateVertices();
            refreshDrawing();
        }
    });

    KeyReader.onkeydown(KeyReader.KEY_MINUS, function () {
        if (menu.shape != null && menu.selected == 'regular') {
            if (menu.shape.sides > 3) {
                menu.shape.sides--;
                menu.shape.updateVertices();
                refreshDrawing();
            }
        }
    });

    KeyReader.onkeydown(KeyReader.KEY_DEL, function () {
        game.world.removeBody(menu.selectedBody);
    });

    $("#game").mousedown(function (event) {
        if (event.which == 3) {
            var center = game.canvas.center;
            active = true;
            $("#game").css('cursor', 'move');
            cp = [reader.x + center[0], reader.y + center[1]];
        }
    });

    $("#game").mouseup(function (event) {
        if (event.which == 3) {
            $("#game").css('cursor', 'default');
            active = false;
        }
        if (menu.mousejoint != null) {
            game.world.removeJoint(menu.mousejoint);
            game.world.mouseJoint = null;
        }
    });
    $("#game").on('mousewheel', function (event) {
        if (!active && !menu.drawing) {
            if (event.deltaY > 0 && game.canvas.scale < 20) {
                game.canvas.scale += 0.1;
                drawing.scale += 0.1;

            }
            else if (game.canvas.scale > 0.2) {
                game.canvas.scale -= 0.1;
                drawing.scale -= 0.1;
            }
            if (!game.running) {
                game.canvas.drawWorld(game.world);
            }
        }
        if (menu.selected == 'regular' && menu.drawing) {
            var sum = event.deltaY;
            if (sum > 0) {
                menu.shape.sides++;
            }
            else if (sum < 0 && menu.shape.sides > 3) {
                menu.shape.sides--;
            }
            menu.shape.updateVertices();
            refreshDrawing();
        }
    });

    $("#game").mousemove(function () {
        if (active) {
            var x = cp[0] - reader.x;
            var y = cp[1] - reader.y;
            var center = [x, y];
            game.canvas.move(center);
            drawing.move(center);
            if (!game.running) {
                game.canvas.drawWorld(game.world);
            }
        }
    });

    $("#action").click(function () {
        if (game.running) {
            game.pause();
        }
        else {
            game.continue();
        }
    });

    var menu = {
        itens: ['quadrado', 'regular', 'circulo', 'cursor', 'eraser', 'move', 'convex'],
        selected: 'cursor',
        drawing: false,
        shape: null,
        selectedBody: null,
        auxpoint: null,
        mousejoint: null,
        select: function (item) {
            this.selected = item;
            $("#" + item).addClass('well well-sm');
            for (var i = 0; i < this.itens.length; i++) {
                if (this.itens[i] != item) {
                    $('#' + this.itens[i]).removeClass('well well-sm');
                }
            }
            this.drawing = false;
            this.shape = null;
            drawing.clearScreen();
        }
    }

    function findSelectedBody() {
        var x = (reader.x + game.canvas.min[0]) / game.canvas.scale;
        var y = (reader.y + game.canvas.min[1]) / game.canvas.scale;
        for (var i = 0; i < game.world.bodies.length; i++) {
            var body = game.world.bodies[i];
            var vertices = body.getVerticesInWorldCoords();
            var xo = MV.min(vertices, 0);
            var yo = MV.min(vertices, 1);
            var xf = MV.max(vertices, 0);
            var yf = MV.max(vertices, 1);
            if (x >= xo && y >= yo && x <= xf && y <= yf) {
                return body;
            }
        }
        return null;
    }

    $("#quadrado,#circulo,#regular,#cursor,#eraser,#move,#convex").click(function () {
        menu.select($(this).attr('id'));
    });

    menu.select('cursor');


    $("#preenchimento").change(function () {
        if (menu.shape != null) {
            menu.shape.color = new Color(document.getElementById("preenchimento").value);
        }
    });

    $("#game").click(function () {
        if (!menu.drawing) {
            var x = (reader.x + game.canvas.min[0]) / game.canvas.scale;
            var y = (reader.y + game.canvas.min[1]) / game.canvas.scale;
            menu.drawPoint = [x, y];
            if (menu.selected == 'quadrado') {
                menu.shape = new Rect([0, 0], 10, 10);
                menu.shape.color = new Color(document.getElementById("preenchimento").value);
                menu.drawing = true;
            }
            else if (menu.selected == 'convex') {
                menu.shape = new Polygon([0, 0], 0);
                menu.shape.vertices.push([x, y]);
                menu.shape.vertices.push(menu.drawPoint);
                menu.shape.color = new Color(document.getElementById("preenchimento").value);
                menu.drawing = true;
            }
            else if (menu.selected == 'regular') {
                if (menu.shape == null) {
                    menu.shape = new Regular([x, y], 10);
                    menu.shape.color = new Color(document.getElementById("preenchimento").value);
                }
                menu.drawing = true;
            }
            else if (menu.selected == 'eraser') {
                var body = findSelectedBody();
                if (body != null) {
                    game.world.removeBody(body);
                }
            }
            else if (menu.selected == 'cursor') {
                var body = findSelectedBody();
                if (body != null) {
                    if (menu.selectedBody != null) {
                        menu.selectedBody.shape.border.lineDash = [];
                    }
                    body.shape.border.lineDash = [5, 5];
                    menu.selectedBody = body;
                }
            }
            else if (menu.selected == 'move') {
                var bodyB = findSelectedBody();
                if (bodyB != null) {
                    var shape = new Shape(menu.drawPoint);
                    shape.vertices[0] = [0, 0];
                    shape.center = menu.drawPoint;
                    var bodyA = new MouseBody(shape);
                    bodyA.center = menu.drawPoint;

                    menu.mousejoint = new Joint(bodyA, 0, bodyB, 0);
                    game.world.addJoint(menu.mousejoint);
                }
            }
        }
        else {
            switch (menu.selected) {
                case 'quadrado':
                    menu.drawing = false;
                    drawing.clearScreen();
                    var body = new Body(menu.shape, Material.Iron, $("#tipo").val() == 'true');
                    game.world.addBody(body);
                    menu.drawPoint = null;
                    break;
                case 'convex':
                    var x = (reader.x + game.canvas.min[0]) / game.canvas.scale;
                    var y = (reader.y + game.canvas.min[1]) / game.canvas.scale;
                    menu.shape.vertices.splice(menu.shape.vertices.length - 1, 1);
                    if (menu.auxpoint != null) {
                        menu.shape.vertices.push(menu.auxpoint);
                        menu.auxpoint = null;
                    }
                    else {
                        menu.shape.vertices.push([x, y]);
                    }

                    menu.shape.vertices.push(menu.drawPoint);
                    break;
                case 'regular':
                    menu.drawing = false;
                    drawing.clearScreen();
                    var body = new Body(menu.shape, Material.Iron, $("#tipo").val() == 'true');
                    game.world.addBody(body);
                    menu.shape = null;
                    menu.drawPoint = null;
                    break;
            }
        }
    });


    $("#game").mousemove(function () {
        var x = (reader.x + game.canvas.min[0]) / game.canvas.scale;
        var y = (reader.y + game.canvas.min[1]) / game.canvas.scale;
        if (menu.drawing && menu.shape != null) {
            drawing.clearScreen();
            switch (menu.selected) {
                case 'quadrado':
                    var w = x - menu.drawPoint[0];
                    var h = y - menu.drawPoint[1];
                    menu.shape.updateDimen(Math.abs(w), Math.abs(h));
                    menu.shape.center = [menu.drawPoint[0] + (w / 2), menu.drawPoint[1] + (h / 2)];
                    drawing.drawShape(menu.shape);
                    break;
                case 'convex':
                    var xo = menu.drawPoint[0];
                    var yo = menu.drawPoint[1];
                    menu.drawPoint[0] = x;
                    menu.drawPoint[1] = y;
                    if (menu.shape.isConvex()) {
                        menu.drawPoint[0] = xo;
                        menu.drawPoint[1] = yo;
                        menu.auxpoint = [xo, yo];
                    }
                    drawing.drawShape(menu.shape);
                    break;
                case 'regular':
                    var r = Math.abs(MV.distance([x, y], menu.drawPoint));
                    menu.shape.setRadius(r);
                    // menu.shape.theta = MV.getDegree([x,y],menu.drawPoint);
                    drawing.drawShape(menu.shape);
                    break;
                case 'circulo':
                    var r = Math.abs(MV.distance([x, y], menu.drawPoint));
                    menu.shape.setRadius(r);
                    drawing.drawShape(menu.shape);
                    break;
            }
        }
        else if (menu.selected != null) {
            switch (menu.selected) {
                case 'move':
                   menu.drawPoint[0] = x;
                   menu.drawPoint[1] = y;
            }
        }
    });

    $("#play-btn").click(function () {
        game.continue();
    });

    $("#pause-btn").click(function () {
        game.pause();
    });
    /*
     var shape1 = new Rect([300, 300], 25, 25);
     var bodyA = new Body(shape1, Material.Iron, true);
     game.world.addBody(bodyA);
     var shape2 = new Rect([300, 400], 100, 100);
     var bodyB = new Body(shape2, Material.Iron, true);

     game.world.addBody(bodyB);
     var joint = new Joint(bodyA, 3, bodyB, 1);
     game.world.addJoint(joint);*/
});
</script>
</head>
<body>
</div>
<div class="row">
    <div class="col-md-12 simulation">
        <div class="canvas-area">
            <canvas id="drawing" width="600px" height="600px"></canvas>
            <canvas id="game" width="600px" height="600px"></canvas>
        </div>
        <div class="tools-area">
            <div id="forms">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        Tools
                    </div>
                    <div class="panel-body">
                        <ul class="nav nav-pills">
                            <li><a id="cursor" class="fa fa-2x fa-hand-o-up"></a></li>
                            <li><a id="eraser" class="fa fa-2x fa-eraser"></a></li>
                            <li><a id="move" class="fa fa-2x fa-arrows"></a></li>
                        </ul>
                        <ul class="nav nav-pills">
                            <li><a id="quadrado" class="fa fa-2x fa-square"></a></li>
                            <li><a id="circulo" class="fa fa-2x fa-circle"></a></li>
                            <li><a id="regular" class="fa fa-2x fa-star"></a></li>
                        </ul>
                        <ul class="nav nav-pills">
                            <li><a id="convex" class="fa fa-2x fa-pencil"></a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="properties">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        Properties
                    </div>
                    <div class="panel-body">
                        <ul class="nav nav-pills nav-stacked">
                            <label for="tipo">Tipo</label>
                            <select id="tipo" class="form-control">
                                <option value="false">Estático</option>
                                <option value="true">Dinâmico</option>
                            </select>
                            <label for="preenchimento">Cor</label>
                            <input class="form-control" type="color" id="preenchimento" value="#ffffff"/>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="game-controls">
        <div class="row">
            <div class="col-md-12 controls">
                <button id="pause-btn" class="btn btn-default">
                    <span class="fa fa-2x fa-pause">

                    </span>
                </button>
                <button id="play-btn" class="btn btn-default">
                    <span class="fa fa-2x fa-play">

                    </span>
                </button>
            </div>
        </div>
    </div>
</div>
