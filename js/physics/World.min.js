define(["QuadTree","MV","FrictionPhysics","AppObject"],function(f,b,e,a){var c=function(h){var g=this;g.dt=1/60;g.nIterations=100;g.beta=0.2;g.bodies=[];g.t=0;g.friction=1;g.contacts=[];g.gravity=90.81;g.width=4000;g.height=4000;g.joints=[];g.quadTree=new f([0,0,g.width,g.height],1);g.removes=[];g.useQuadTree=true;g.debug=false;g.set(h)};c.prototype=new a;c.prototype.step=function(){var x=this;x.computeContacts(x);var h=x.bodies;var v=h.length;var r;var g;var y;var t;var o;var l;var q;var p;var u;var n;var m=x.dt;var s;var k;var w;for(q=0;q<v;q++){r=h[q];g=r.mInv;if(g!=0&&r.dinamic){y=r.getRotationMatrix();o=r.forces;t=o.length;n=r.forcePoints;for(p=0;p<t;p++){u=n[p];l=o[p];k=m*g;r.set({vLin:[r.vLin[0]+l[0]*k,r.vLin[1]+l[1]*k]});if(u!==undefined){w=r.shape.vertices[u];s=(y[0][0]*w[0]+y[0][1]*w[1])*l[1]-(y[1][0]*w[0]+y[1][1]*w[1])*l[0]}}}}x.applyJoints();x.applyImpulses();x.move()};c.prototype.move=function(){var g=this;g.quadTree.clear();g.removes.forEach(function(i){var h=g.bodies.indexOf(i);if(h!=-1){g.bodies[h].destroy();g.bodies.splice(h,1)}});g.removes=[];g.bodies.forEach(function(i,l,k){i.index=l;var j=!0;if(i.dinamic){var m=b.VpV(i.center,b.SxV(d.dt,i.vLin)),h=d.dt*i.vAng;i.center=m;i.shape.center=i.center;i.shape.theta+=h;m=e.getAABB(i);if(!e.AABBoverlap(m,d.quadTree.AABB,0)){k[l].destroy();k.splice(l,1);j=!1}}j&&d.quadTree.add(i);i.vertsAbsolute=null;i.AABB=null})};c.prototype.clear=function(){var g=this;var h;for(h=0;h<g.bodies.length;h++){g.remove(g.bodies[h])}return g};c.prototype.add=function(g){var h=this;if(g.dinamic){g.set({forces:[[0,h.gravity*g.mass]],forcePoints:[]})}h.bodies.push(g);if(h.useQuadTree){h.quadTree.add(g)}g.set({index:h.bodies.length-1});return h};c.prototype.setGravity=function(l){l*=10;var h=this;var k=h.bodies.length;var j;var g;h.gravity=l;for(j=0;j<k;j++){g=h.bodies[j];if(g.dinamic){g.set({forces:[[0,h.gravity*g.mass]],forcePoints:[]})}}};c.prototype.remove=function(g,j){var h=this;j=j==undefined?false:j;if(!j){h.removes.push(g)}else{var i=h.bodies.indexOf(g);if(i!=-1){h.bodies.splice(i,1);if(h.useQuadTree){h.quadTree.remove(g)}}}};c.prototype.addJoint=function(h){var g=this;g.joints.push(h)};c.prototype.removeJoint=function(l){var h=this;var g=h.joints;var k=g.length;var j;for(j=0;j<k;j++){if(g[j]==l){g.splice(j,1);break}}};c.prototype.setFriction=function(h){var g=this;g.friction=h};c.prototype.computeContacts=function(){var g=this;var h=e.getCollisionCandidates(g);e.computeFaceNormals(g.bodies,h);g.contacts=[];var k=h.length;var m;var o;var n;var j;var l;for(j=0;j<k;j++){m=h[j];o=g.bodies[m[0]];n=g.bodies[m[1]];if(o.dinamic||n.dinamic){l=e.getContactsFromBodyPair(o,n);g.contacts=g.contacts.concat(l)}}};c.prototype.applyJoints=function(){var s=this;var E=s.joints;var q=E.length;if(q>0){var h=[];var w=[];var x=[];var y;var I;var G;var P;var g;var T;var V;var S;var O;var F=s.beta;var m=s.dt;var Q;var D;var H;var N;var K=s.nIterations;var t;var r;var M;var L;var U;var A;var z;var p;var o;var C;var B;var u;var l;var R;for(P=0;P<q;P++){y=E[P];V=y.bodyA;S=y.bodyB;g=V.center;T=S.center;A=y.vertexA;z=y.vertexB;t=V.mInv;r=S.mInv;M=V.moiInv;L=S.moiInv;h[P]=[r,r,L,t,t,M];U=y.type;if(U=="vertex"){I=V.getVerticesInWorldCoords()[A];G=S.getVerticesInWorldCoords()[z]}else{if(U=="center"){I=V.getVerticesInWorldCoords()[A];G=T}else{if(U=="surface"){I=[A[0]+g[0],A[1]+g[1]];G=[z[0]+T[0],z[1]+T[1]]}}}u=[I[0]-G[0],I[1]-G[1]];l=[G[0]-I[0],G[1]-I[1]];x[P]=[l[0]*2,l[1]*2,u[0]*(G[1]-T[1])-u[1]*(G[0]-T[0]),u[0],u[1],l[0]*(I[1]-g[1])-l[1]*(I[0]-g[0])];w[P]=F/m*(u[0]*u[0]+u[1]*u[1])}for(P=0;P<K;P++){for(O=0;O<q;O++){D=0;for(N=0;N<=5;N++){D+=h[O][N]*x[O][N]*x[O][N]}if(Math.abs(D)<=1e-15){continue}V=E[O].bodyA;S=E[O].bodyB;p=V.vLin;o=S.vLin;C=V.vAng;B=S.vAng;H=[o[0],o[1],B,p[0],p[1],C];R=0;for(N=0;N<=5;N++){R+=x[O][N]*H[N]}Q=-(R+w[O])/D;for(N=0;N<=5;N++){H[N]=Q*x[O][N]*h[O][N]+H[N]}if(s.debug){S.set({vLin:[H[0],H[1]],vAng:H[2]});V.set({vLin:[H[3],H[4]],vAng:H[5]})}else{S.vLin=[H[0],H[1]];S.vAng=H[2];V.vLin=[H[3],H[4]];V.vAng=H[5]}}}}};c.prototype.applyImpulses=function(){var h=[];var u=[];var H=[];var K=[];var I=[];var U;var T;var s=this;var A=s.contacts;var q=A.length;var w;var ac;var aa;var p;var o;var D;var B;var t;var r;var R;var Q;var O;var N;var L;var g;var ab;var J=s.beta;var m=s.dt;var x;var l;var E=s.friction;var P=s.nIterations;var M;var y;var V;var F;var z;var G;var Z;var Y;var X;var W;var S;for(U=0;U<q;U++){w=A[U];N=w.pA;L=w.pB;ac=w.bodyA;aa=w.bodyB;p=ac.vLin;o=aa.vLin;D=ac.vAng;B=aa.vAng;g=ac.center;ab=aa.center;t=ac.mInv;r=aa.mInv;R=ac.moiInv;Q=aa.moiInv;h[U]=[t,t,R,r,r,Q];O=w.normal;F=[N[0]-g[0],N[1]-g[1]];z=[L[0]-ab[0],L[1]-ab[1]];K[U]=[O[0],O[1],F[0]*O[1]-F[1]*O[0],-O[0],-O[1],-(z[0]*O[1]-z[1]*O[0])];I[U]=[-O[1],O[0],F[0]*O[0]-F[1]*-O[1],O[1],-O[0],-((L[0]-ab[0])*-O[1]-(L[1]-ab[1])*-O[1])];l=((-(N[1]-g[1])*D+p[0])-(-(L[1]-ab[1])*B+o[0])*O[0])+(((N[0]-g[0])*D+p[1])-((L[0]-ab[0])*B+o[1])*O[1]);x=(N[0]-L[0])*O[0]+(N[1]-L[1])*O[1];u[U]=J/m*((x<0)?x:0)+0.1*l;H[U]=0}for(U=0;U<P;U++){for(T=0;T<q;T++){w=A[T];ac=w.bodyA;aa=w.bodyB;p=ac.vLin;o=aa.vLin;D=ac.vAng;B=aa.vAng;M=[p[0],p[1],D,o[0],o[1],B];Z=0;Y=0;X=0;W=0;for(S=0;S<=5;S++){Z+=K[T][S]*M[S];Y+=h[T][S]*K[T][S]*K[T][S];X+=I[T][S]*M[S];W+=h[T][S]*I[T][S]*I[T][S]}V=-(Z+u[T])/Y;y=-X/W;if(H[T]+V<0){V=-H[T]}G=E*V;if(y>G){y=G}else{if(y<-G){y=-G}}H[T]+=V;for(S=0;S<=5;S++){M[S]=(h[T][S]*y*I[T][S])+((h[T][S]*V*K[T][S])+M[S])}if(s.debug){ac.set({vLin:[M[0],M[1]],vAng:M[2]});aa.set({vLin:[M[3],M[4]],vAng:M[5]})}else{ac.vLin=[M[0],M[1]];ac.vAng=M[2];aa.vLin=[M[3],M[4]];aa.vAng=M[5]}}}};c.prototype.getAABBsGroups=function(){var i=this;var h=i.bodies;var g=h.map(function(j){return e.getAABB(j)});return[[h,g]]};return c});