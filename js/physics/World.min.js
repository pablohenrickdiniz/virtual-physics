var World=function(){function z(){var g=this;g.quadTree.clear();g.removes.forEach(function(k){k=g.bodies.indexOf(k);-1!=k&&g.bodies.splice(k,1)});g.removes=[];g.bodies.forEach(function(k,l,h){k.index=l;var p=!0;if(k.dinamic){var e=MV.VpV(k.center,MV.SxV(g.dt,k.vLin)),b=g.dt*k.vAng;k.center=e;k.shape.center=k.center;k.shape.theta+=b;e=getAABB(k);AABBoverlap(e,g.quadTree.AABB,0)||(h.splice(l,1),p=!1)}p&&g.quadTree.addBody(k);k.vertsAbsolute=null})}function A(){var g=getCollisionCandidates(this);computeFaceNormals(this.bodies,
    g);this.contacts=[];var k=g.length,l,h,p;for(p=0;p<k;p++)if(l=g[p],h=this.bodies[l[0]],l=this.bodies[l[1]],h.dinamic||l.dinamic)h=getContactsFromBodyPair(h,l),this.contacts=this.contacts.concat(h)}function B(){var g=[],k=[],l=[],h,p=this.joints,e,b,q,m,c,f,a,r=p.length,d=this.beta,n=this.dt,s=this.nIterations,u,v,t,x,w,y;for(q=0;q<r;q++)h=p[q],f=h.bodyA,a=h.bodyB,m=f.center,c=a.center,w=h.vertexA,y=h.vertexB,u=f.mInv,v=a.mInv,t=f.moiInv,x=a.moiInv,g[q]=[v,v,x,u,u,t],h=h.type,"vertex"==h?(e=f.getVerticesInWorldCoords()[w],
    b=a.getVerticesInWorldCoords()[y]):"center"==h?(e=f.getVerticesInWorldCoords()[w],b=c):"surface"==h&&(e=[w[0]+m[0],w[1]+m[1]],b=[y[0]+c[0],y[1]+c[1]]),f=[e[0]-b[0],e[1]-b[1]],a=[b[0]-e[0],b[1]-e[1]],l[q]=[2*a[0],2*a[1],f[0]*(b[1]-c[1])-f[1]*(b[0]-c[0]),f[0],f[1],a[0]*(e[1]-m[1])-a[1]*(e[0]-m[0])],k[q]=d/n*(f[0]*f[0]+f[1]*f[1]);for(q=0;q<s;q++)for(e=0;e<r;e++){for(c=b=0;5>=c;c++)b+=g[e][c]*l[e][c]*l[e][c];if(!(1E-15>=Math.abs(b))){f=p[e].bodyA;a=p[e].bodyB;m=f.vLin;c=a.vLin;d=f.vAng;n=a.vAng;m=[c[0],
    c[1],n,m[0],m[1],d];for(c=d=0;5>=c;c++)d+=l[e][c]*m[c];b=-(d+k[e])/b;for(c=0;5>=c;c++)m[c]=b*l[e][c]*g[e][c]+m[c];a.vLin=[m[0],m[1]];a.vAng=m[2];f.vLin=[m[3],m[4]];f.vAng=m[5]}}}function C(){var g=[],k=[],l=[],h=[],p=[],e,b,q=this.contacts,m=q.length,c,f,a,r,d,n,s,u,v,t;b=this.beta;r=this.dt;var x=this.friction,w=this.nIterations;for(e=0;e<m;e++)c=q[e],d=c.pA,n=c.pB,f=c.bodyA,a=c.bodyB,t=f.center,s=a.center,u=f.mInv,v=a.mInv,f=f.moiInv,a=a.moiInv,g[e]=[u,u,f,v,v,a],a=c.normal,f=[d[0]-t[0],d[1]-t[1]],
    c=[n[0]-s[0],n[1]-s[1]],h[e]=[a[0],a[1],f[0]*a[1]-f[1]*a[0],-1*a[0],-1*a[1],-(c[0]*a[1]-c[1]*a[0])],p[e]=[-a[1],a[0],f[0]*a[0]-f[1]*-a[1],a[1],-a[0],-((n[0]-s[0])*-a[1]-(n[1]-s[1])*-a[1])],a=(d[0]-n[0])*a[0]+(d[1]-n[1])*a[1],k[e]=b/r*(0>a?a:0)+0,l[e]=0;for(e=0;e<w;e++)for(b=0;b<m;b++){c=q[b];f=c.bodyA;a=c.bodyB;r=f.vLin;d=a.vLin;n=f.vAng;s=a.vAng;r=[r[0],r[1],n,d[0],d[1],s];for(d=c=s=t=n=0;5>=d;d++)n+=h[b][d]*r[d],t+=g[b][d]*h[b][d]*h[b][d],s+=p[b][d]*r[d],c+=g[b][d]*p[b][d]*p[b][d];n=-(n+k[b])/t;
    s=-s/c;0>l[b]+n&&(n=-l[b]);d=x*n;s>d?s=d:s<-d&&(s=-d);l[b]+=n;for(d=0;5>=d;d++)r[d]=g[b][d]*s*p[b][d]+(g[b][d]*n*h[b][d]+r[d]);f.vLin=[r[0],r[1]];f.vAng=r[2];a.vLin=[r[3],r[4]];a.vAng=r[5]}}this.dt=1/60;this.nIterations=20;this.beta=.2;this.bodies=[];this.t=0;this.friction=.5;this.contacts=[];this.gravity=200;this.height=this.width=4E3;this.joints=[];this.quadTree=new QuadTree([0,0,this.width,this.height],1,Math.max((this.width+this.height)/2/500),4);this.removes=[];this.step=function(){A.apply(this);
    var g=this.bodies,k=g.length,l,h,p,e,b,q,m,c=this.dt,f;for(q=0;q<k;q++)if(l=g[q],h=l.mInv,0!=h&&l.dinamic)for(l.getRotationMatrix(),e=l.forces,p=e.length,m=0;m<p;m++)b=e[m],f=c*h,l.vLin=[l.vLin[0]+b[0]*f,l.vLin[1]+b[1]*f];B.apply(this);C.apply(this);z.apply(this)};this.addBody=function(g){g.dinamic&&g.addForce([0,this.gravity*g.mass]);this.bodies.push(g);this.quadTree.addBody(g);g.index=this.bodies.length-1};this.removeBody=function(g){this.removes.push(g)};this.addJoint=function(g){this.joints.push(g)};
    this.removeJoint=function(g){var k=this.joints,l=k.length,h;for(h=0;h<l;h++)if(k[h]==g){k.splice(h,1);break}}};