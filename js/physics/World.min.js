var World=function(){function x(){this.quadTree.clear();var e=this;this.removes.forEach(function(h){h=e.bodies.indexOf(h);-1!=h&&e.bodies.splice(h,1)});this.removes=[];this.bodies.forEach(function(h,f,c){h.index=f;var n=!0;if(h.dinamic){var b=MV.VpV(h.center,MV.SxV(e.dt,h.vLin)),a=e.dt*h.vAng;h.center=b;h.shape.center=h.center;h.shape.theta+=a;b=getAABB(h);AABBoverlap(b,e.quadTree.AABB,0)||(c.splice(f,1),n=!1)}n&&e.quadTree.addBody(h)})}function y(){var e=getCollisionCandidates(this);computeFaceNormals(this.bodies,
    e);this.contacts=[];for(var h=e.length,f,c,n=0;n<h;n++)if(f=e[n],c=this.bodies[f[0]],f=this.bodies[f[1]],c.dinamic||f.dinamic)c=getContactsFromBodyPair(c,f),this.contacts=this.contacts.concat(c)}function z(){var e=[],h=[],f=[],c,n=this.joints,b,a,m,p,d,g,k=n.length;g=this.beta;var l=this.dt,r=this.nIterations,q,s,u,v,t,w;for(a=0;a<k;a++)c=n[a],b=c.bodyA,d=c.bodyB,m=b.center,p=d.center,t=c.vertexA,w=c.vertexB,q=b.mInv,s=d.mInv,u=b.moiInv,v=d.moiInv,e[a]=[s,s,v,q,q,u],c=c.type,"vertex"==c?(b=b.getVerticesInWorldCoords()[t],
    c=d.getVerticesInWorldCoords()[w]):(b=b.getVerticesInWorldCoords()[t],c=p),w=MV.VmV(b,c),t=MV.VmV(c,b),d=MV.SxV(2,t),p=MV.cross2(w,MV.VmV(c,p)),b=MV.cross2(t,MV.VmV(b,m)),f[a]=[d[0],d[1],p,w[0],w[1],b],d=MV.dot(w,w),h[a]=g/l*d;for(a=0;a<r;a++)for(g=0;g<k;g++)l=MV.dot(f[g],MV.VxV(e[g],f[g])),1E-15>=Math.abs(l)||(b=n[g].bodyA,d=n[g].bodyB,m=b.vLin,p=d.vLin,w=b.vAng,t=d.vAng,m=[p[0],p[1],t,m[0],m[1],w],l=-(MV.dot(f[g],m)+h[g])/l,m=MV.VpV(m,MV.VxV(e[g],MV.SxV(l,f[g]))),d.vLin=[m[0],m[1]],d.vAng=m[2],
    b.vLin=[m[3],m[4]],b.vAng=m[5])}function A(){var e=[],h=[],f=[],c=[],n=[],b,a,m=this.contacts,p=m.length,d,g,k,l,r,q,s,u,v,t;a=this.beta;l=this.dt;var w=this.friction,x=this.nIterations;for(b=0;b<p;b++)d=m[b],r=d.pA,q=d.pB,g=d.bodyA,k=d.bodyB,t=g.center,s=k.center,u=g.mInv,v=k.mInv,g=g.moiInv,k=k.moiInv,e[b]=[u,u,g,v,v,k],k=d.normal,t=MV.VmV(r,t),u=MV.VmV(q,s),g=MV.cross2(t,k),d=MV.SxV(-1,k),u=-MV.cross2(u,k),c[b]=[k[0],k[1],g,d[0],d[1],u],v=[-k[1],k[0]],g=MV.cross2(t,v),d=MV.SxV(-1,v),u=-MV.cross2(MV.VmV(q,
    s),v),n[b]=[v[0],v[1],g,d[0],d[1],u],k=MV.dot(MV.VmV(r,q),k),h[b]=a/l*(0>k?k:0)+0,f[b]=0;for(b=0;b<x;b++)for(a=0;a<p;a++)d=m[a],g=d.bodyA,k=d.bodyB,l=g.vLin,r=k.vLin,q=g.vAng,s=k.vAng,l=[l[0],l[1],q,r[0],r[1],s],q=-(MV.dot(c[a],l)+h[a])/MV.dot(c[a],MV.VxV(e[a],c[a])),0>f[a]+q&&(q=-f[a]),r=-MV.dot(n[a],l)/MV.dot(n[a],MV.VxV(e[a],n[a])),s=w*q,r>s?r=s:r<-s&&(r=-s),f[a]+=q,l=MV.VpV(MV.VpV(l,MV.VxV(e[a],MV.SxV(q,c[a]))),MV.VxV(e[a],MV.SxV(r,n[a]))),g.vLin=[l[0],l[1]],g.vAng=l[2],k.vLin=[l[3],l[4]],k.vAng=
    l[5]}this.dt=1/60;this.nIterations=20;this.beta=.2;this.bodies=[];this.t=0;this.friction=.5;this.contacts=[];this.gravity=200;this.height=this.width=5E3;this.joints=[];this.quadTree=new QuadTree([0,0,this.width,this.height],1);this.removes=[];this.step=function(){y.apply(this);var e=this.bodies,h=e.length,f,c,n,b,a,m,p,d,g,k,l=this.dt;for(p=0;p<h;p++)if(f=e[p],c=f.mInv,0!=c&&f.dinamic)for(n=f.getRotationMatrix(),a=f.forces,b=a.length,k=f.forcePoints,d=0;d<b;d++)g=k[d],m=a[d],f.vLin=MV.VpV(f.vLin,
    MV.SxV(l*c,m)),void 0!==g&&(m=MV.cross2(MV.MxV(n,f.shape.vertices[g]),m),f.vAng+=l*f.moiInv*m);z.apply(this);A.apply(this);x.apply(this)};this.addBody=function(e){e.dinamic&&e.addForce([0,this.gravity*e.mass]);this.bodies.push(e);this.quadTree.addBody(e);e.index=this.bodies.length-1};this.removeBody=function(e){this.removes.push(e)};this.addJoint=function(e){this.joints.push(e)};this.removeJoint=function(e){var h=this.joints,f=h.length,c;for(c=0;c<f;c++)if(h[c]==e){h.splice(c,1);break}}};