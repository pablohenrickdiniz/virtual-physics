define(["Game","React","ToolMenu","Rect","Math","Body","Material","Polygon","KeyReader","Regular","Color","FrictionPhysics","MV","Border","chart"],function(f,c,g,a,d,p,i,l,n,o,b,m,k,h,j){var e={game:null,tools:[{name:"cursor",icon:"fa fa-2x fa-hand-o-up"},{name:"move",icon:"fa fa-2x fa-arrows"},{name:"convex",icon:"fa fa-2x fa-pencil"},{name:"rect",icon:"fa fa-2x fa-square"},{name:"circle",icon:"fa fa-2x fa-circle"},{name:"regular",icon:"fa fa-2x fa-star"}],selectedTool:null,shape:null,drawing:false,color:"rgba(0,0,0,0)",dinamic:true,chart:null,selectedBodies:[],lastLoop:null,bodiesQtd:[0,50,100,150,200,250,300,350,400,450,500],times:[0,0,0,0,0,0,0,0,0,0,0],initialize:function(){var r=this;var q=r.getGame();q.start();r.initializeTools()},initializeTools:function(){var s=this;var r=s.getGame();var v=r.getCanvasEngine();var w=v.getMouseReader();var u=v.getKeyReader();var q=r.getDrawLayer();var t=r.getWorld();u.onSequence([n.Keys.KEY_ENTER],function(){console.log("keydown");if(s.selectedTool=="convex"&&s.drawing){var y=s.shape;if(y.vertices.length>=3&&!y.isConvex()){if(!y.isClockWise()){y.invertPath()}y.updateCenter();y.updateRelative();var x=new p({shape:y,material:i.Iron,dinamic:s.dinamic});r.getWorld().add(x);s.drawing=false;s.shape=null;q.clear()}}});u.onSequence([n.Keys.KEY_UP],function(){if(s.selectedTool=="regular"&&s.drawing){s.shape.set({sides:s.shape.sides+1});q.clear().drawShape(s.shape)}});u.onSequence([n.Keys.KEY_DOWN],function(){if(s.selectedTool=="regular"&&s.drawing){s.shape.set({sides:s.shape.sides-1});q.clear().drawShape(s.shape)}});u.onSequence([n.Keys.KEY_DEL],function(){s.selectedBodies.forEach(function(x){t.remove(x)})});w.onmousemove(function(){var I=e;if(w.left&&I.selectedTool=="move"){var A=w.lastDown.left;var J=w.lastMove;var B=e.getGame().getCanvasEngine().scale;A=d.sdv(B,A);J=d.sdv(B,J);var C=d.vmv(J,A);var H=C.x/2;var D=C.h/2;var G=A.x+(C.x/2);var F=A.y+(C.y/2);var E=new a({width:d.abs(C.x),height:d.abs(C.y),center:[G,F],border:new h({lineDash:[5,5]})});q.clear().drawShape(E);I.selectedBodies.forEach(function(x){x.shape.border.setLineDash([])});var z=e.findSelectedBodies(E);z.forEach(function(x){x.shape.border.setLineDash([5,5])});I.selectedBodies=z}});w.onmouseup(1,function(){if(s.selectedTool=="move"){q.clear()}});w.onmousedown(1,function(){switch(s.selectedTool){case"rect":s.executeRectTool(this.lastDown.left);break;case"convex":s.executePolygonTool(this.lastDown.left);break;case"regular":s.executeRegularTool(this.lastDown.left);break}if(s.drawing){q.clear().drawShape(s.shape)}else{q.clear();s.shape=null}});w.onmousemove(function(){var y=this;if(s.drawing){var z=y.lastDown.left;var x=y.lastMove;switch(s.selectedTool){case"rect":s.executeRectMove(z,x);break;case"convex":s.executePolygonMove(x);break;case"regular":s.executeRegularMove(z,x);break}q.clear().drawShape(s.shape)}});c.render(c.createElement(g,{items:s.tools,onItemCheck:s.onToolSelect}),document.getElementById("tool-menu"));$("#color").change(function(){s.color=$(this).val();if(s.shape!=null){s.shape.set({color:s.color});q.clear().drawShape(s.shape)}});$("#friccao").change(function(){e.getGame().getWorld().setFriction($(this).val())});$("#gravidade").change(function(){e.getGame().getWorld().setGravity($(this).val())});$("#dinamico").change(function(){s.dinamic=$(this).is(":checked")});$("#show-quadtree").change(function(){e.getGame().setShowQuadTree($(this).is(":checked"))});$("#show-aabb").change(function(){e.getGame().setShowAABBS($(this).is(":checked"))});$("#play-btn").click(function(){e.getGame().start()});$("#pause-btn").click(function(){e.getGame().pause()})},executeRectTool:function(s){var t=this;if(!t.drawing){t.drawing=true;var u=e.getGame().getCanvasEngine().scale;s=d.sdv(u,s);var r=[s.x,s.y];t.shape=new a({center:r,width:10,height:10,color:t.color})}else{t.drawing=false;var q=new p({shape:t.shape,material:i.Iron,dinamic:t.dinamic});t.getGame().getWorld().add(q)}},executePolygonTool:function(q){var y=this;if(!y.drawing){y.drawing=true;var r=e.getGame().getCanvasEngine().scale;q=d.sdv(r,q);var x=[q.x,q.y];var w=[q.x,q.y];var v=[q.x,q.y+1];y.shape=new l({center:x,vertices:[w,v]})}else{var u=false;var s=y.shape.vertices;var x=[q.x-1,q.y-1];var w=[q.x-1,q.y+1];var v=[q.x+1,q.y-1];var t=[q.x+1,q.y+1];if(!y.shape.contains(x)){if(!l.isConvex(s.concat([x]))){u=y.shape.add(x)}}if(!u&&!y.shape.contains(w)){if(!l.isConvex(s.concat([w]))){u=y.shape.add(w)}}if(!u&&!y.shape.contains(v)){if(!l.isConvex(s.concat([v]))){u=y.shape.add(v)}}if(!u&&!y.shape.contains(t)){if(!l.isConvex(s.concat([t]))){u=y.shape.add(t)}}}},executeRegularTool:function(s){var r=this;if(!r.drawing){r.drawing=true;var t=e.getGame().getCanvasEngine().scale;s=d.sdv(t,s);r.shape=new o({center:[s.x,s.y]})}else{r.drawing=false;var q=new p({shape:r.shape,material:i.Iron,dinamic:r.dinamic});r.getGame().getWorld().add(q)}},executeRegularMove:function(s,q){var r=this;var t=r.getGame().getCanvasEngine().scale;s=d.sdv(t,s);q=d.sdv(t,q);var u=d.distance(s,q);r.shape.set({radius:u})},executeRectMove:function(q,A){var r=e.getGame().getCanvasEngine().scale;q=d.sdv(r,q);A=d.sdv(r,A);var s=d.vmv(A,q);var z=this;var w=s.x/2;var t=s.h/2;var v=q.x+(s.x/2);var u=q.y+(s.y/2);z.shape.set({width:d.abs(s.x),height:d.abs(s.y),center:[v,u]})},executePolygonMove:function(r){var s=this;if(!s.shape.contains([r.x-1,r.y-1])){var t=s.shape.last();var q=t[0];var u=t[1];t[0]=r.x-1;t[1]=r.y-1;if(s.shape.isConvex()){t[0]=q;t[1]=u}}},getGame:function(){var q=this;if(q.game==null){q.game=new f({container:"#canvas-container",loopCallback:function(){var t=0;if(!q.lastCalledTime){q.lastCalledTime=Date.now()}else{var u=(new Date().getTime()-q.lastCalledTime)/1000;q.lastCalledTime=Date.now();t=1/u;var s=q.game.getWorld().bodies.length;var r=q.bodiesQtd.indexOf(s);if(r!=-1){q.times[r]=t;q.updateChart()}}}})}return q.game},onToolSelect:function(q){e.selectedTool=q},findSelectedBodies:function(t){var s=this;var r=[];var w;var q;var v=s.getGame().getWorld().bodies;var u=v.length;for(w=0;w<u;w++){q=v[w];if(m.AABBoverlap(m.getAABB2(t.getVerticesInWorldCoords()),q.getAABB())){r.push(q)}}return r},findSelectedBody:function(){var D=this;var C=e.getGame();var v=C.getCanvasEngine().scale;var B=C.getMouseReader().lastDown.left;B=d.sdv(v,B);var x;var y;var z=C.getWorld();var q=z.bodies;var u=q.length;var A;var w;var s;var r;var t;for(x=0;x<u;x++){y=q[x];A=y.shape;if(A.contains(B)){q.push(y)}}s=q.length;if(s>0){w=0;r=k.distance(q[0].center,B);for(x=1;x<s;x++){t=k.distance(q[x].center,B);if(t<r){r=t;w=x}}if(w!=-1){return q[w]}}return null},getPerformanceChart:function(){var r=this;if(r.chart==null){var q=$("#chart")[0].getContext("2d");console.log(q);var s=j.noConflict();r.chart=new s(q)}return r.chart},updateChart:function(){var q=this;q.getPerformanceChart().Line({labels:q.bodiesQtd,datasets:[{label:"My First dataset",fillColor:"rgba(220,220,220,0.2)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(220,220,220,1)",data:q.times}]})}};return e});